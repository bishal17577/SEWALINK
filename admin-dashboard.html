<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5">
  <title>SewaLink ¬∑ Admin Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    body {
      background: #f8fafc;
    }

    .admin-wrapper {
      display: flex;
      min-height: 100vh;
    }

    /* ========== SIDEBAR ========== */
    .sidebar {
      width: 300px;
      background: white;
      border-right: 1px solid #e2e8f0;
      display: flex;
      flex-direction: column;
      transition: all 0.3s;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
    }

    .sidebar-header {
      padding: 1.5rem;
      border-bottom: 1px solid #e2e8f0;
    }

    .sidebar-logo {
      font-size: 1.6rem;
      font-weight: 700;
      color: #0f4c81;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .sidebar-logo span {
      color: #2563eb;
    }

    .admin-info {
      padding: 1rem 1.5rem;
      background: #f8fafc;
      margin: 1rem;
      border-radius: 16px;
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }
    .admin-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #2563eb;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1.2rem;
    }
    .admin-details h4 {
      font-size: 0.9rem;
      color: #0f172a;
    }
    .admin-details p {
      font-size: 0.75rem;
      color: #64748b;
    }

    .sidebar-nav {
      flex: 1;
      padding: 0 1rem;
      overflow-y: auto;
    }

    .nav-section {
      margin-bottom: 1.5rem;
    }

    .nav-section-title {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #94a3b8;
      font-weight: 600;
      margin-bottom: 0.5rem;
      padding-left: 0.8rem;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      padding: 0.7rem 1rem;
      border-radius: 12px;
      color: #334155;
      text-decoration: none;
      font-size: 0.9rem;
      transition: all 0.2s;
      margin-bottom: 0.2rem;
      cursor: pointer;
    }
    .nav-item i {
      width: 20px;
      color: #64748b;
    }
    .nav-item:hover {
      background: #f1f5f9;
      color: #2563eb;
    }
    .nav-item.active {
      background: #eff6ff;
      color: #2563eb;
    }
    .nav-item.active i {
      color: #2563eb;
    }

    /* ========== MAIN CONTENT ========== */
    .main-content {
      flex: 1;
      margin-left: 300px;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .top-bar {
      background: white;
      padding: 1rem 2rem;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .page-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: #0f172a;
    }

    .top-bar-actions {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .notification-badge {
      position: relative;
      cursor: pointer;
    }
    .badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #ef4444;
      color: white;
      border-radius: 50%;
      padding: 0.2rem 0.5rem;
      font-size: 0.7rem;
    }

    .content-area {
      padding: 2rem;
      overflow-y: auto;
    }

    /* ========== STATS CARDS ========== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      border-radius: 20px;
      padding: 1.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.02);
      border: 1px solid #f1f5f9;
    }

    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .stat-icon {
      width: 48px;
      height: 48px;
      background: #eff6ff;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .stat-icon i {
      font-size: 1.5rem;
      color: #2563eb;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: #0f172a;
    }
    .stat-label {
      color: #64748b;
      font-size: 0.9rem;
    }

    /* ========== COIN MANAGEMENT SECTION ========== */
    .coin-section {
      background: linear-gradient(135deg, #f59e0b, #fbbf24);
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 2rem;
      color: white;
    }

    .coin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .coin-header h2 {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .total-coins {
      font-size: 2.5rem;
      font-weight: 700;
    }

    .coin-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .coin-stat {
      background: rgba(255,255,255,0.2);
      padding: 1rem;
      border-radius: 12px;
      text-align: center;
    }

    .coin-stat-value {
      font-size: 1.8rem;
      font-weight: 700;
    }

    .coin-stat-label {
      font-size: 0.8rem;
      opacity: 0.9;
    }

    /* ========== QR CODE SECTION ========== */
    .qr-section {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      border: 1px solid #f1f5f9;
      margin-bottom: 2rem;
    }

    .qr-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
      margin-top: 1.5rem;
    }

    .qr-card {
      background: #f8fafc;
      border-radius: 16px;
      padding: 1.5rem;
      text-align: center;
      transition: all 0.3s ease;
    }

    .qr-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .qr-preview {
      width: 200px;
      height: 200px;
      margin: 1rem auto;
      background: white;
      padding: 1rem;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .qr-preview img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .qr-upload-btn {
      background: #2563eb;
      color: white;
      padding: 0.8rem 2rem;
      border-radius: 30px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      margin: 1rem 0;
    }
    .qr-upload-btn:active {
      background: #1d4ed8;
      transform: scale(0.98);
    }

    #qrUpload {
      display: none;
    }

    .qr-actions {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      margin-top: 1rem;
    }

    /* ========== PAYMENT SECTION ========== */
    .payment-section {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      border: 1px solid #f1f5f9;
      margin-bottom: 2rem;
    }

    .commission-slider {
      display: flex;
      align-items: center;
      gap: 2rem;
      margin: 1.5rem 0;
      padding: 1rem;
      background: #f8fafc;
      border-radius: 12px;
    }

    /* ========== CATEGORY SECTION ========== */
    .category-section {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      border: 1px solid #f1f5f9;
      margin-bottom: 2rem;
    }

    .category-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .category-card {
      background: #f8fafc;
      border-radius: 16px;
      padding: 1rem;
      border: 1px solid #f1f5f9;
    }

    .category-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .category-name {
      font-weight: 600;
      color: #0f172a;
    }

    .category-stats {
      display: flex;
      gap: 0.5rem;
      font-size: 0.7rem;
      color: #64748b;
    }

    /* ========== SETTINGS SECTION ========== */
    .settings-section {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      border: 1px solid #f1f5f9;
      margin-bottom: 2rem;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
    }

    .settings-card {
      background: #f8fafc;
      border-radius: 16px;
      padding: 1.5rem;
    }

    .settings-icon {
      width: 48px;
      height: 48px;
      background: #eff6ff;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 1rem;
    }

    .settings-icon i {
      font-size: 1.5rem;
      color: #2563eb;
    }

    /* ========== TABLES ========== */
    .table-container {
      background: white;
      border-radius: 20px;
      padding: 1.5rem;
      border: 1px solid #f1f5f9;
      margin-bottom: 2rem;
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .table-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #0f172a;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      text-align: left;
      padding: 0.8rem 1rem;
      background: #f8fafc;
      color: #334155;
      font-size: 0.8rem;
      font-weight: 600;
    }

    td {
      padding: 1rem;
      border-bottom: 1px solid #f1f5f9;
      color: #334155;
      font-size: 0.9rem;
    }

    .badge {
      padding: 0.3rem 0.8rem;
      border-radius: 50px;
      font-size: 0.7rem;
      font-weight: 600;
    }
    .badge-success { background: #dcfce7; color: #166534; }
    .badge-warning { background: #fef9c3; color: #854d0e; }
    .badge-danger { background: #fee2e2; color: #b91c1c; }
    .badge-info { background: #dbeafe; color: #1e40af; }

    .btn {
      padding: 0.4rem 1rem;
      border-radius: 30px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    .btn-primary { background: #2563eb; color: white; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-success { background: #22c55e; color: white; }
    .btn-warning { background: #f59e0b; color: white; }
    .btn-info { background: #3b82f6; color: white; }
    .btn-sm { padding: 0.2rem 0.8rem; font-size: 0.7rem; }

    .search-box {
      display: flex;
      align-items: center;
      background: white;
      border: 1.5px solid #e2e8f0;
      border-radius: 50px;
      padding: 0.5rem 1rem;
    }
    .search-box i {
      color: #94a3b8;
      margin-right: 0.5rem;
    }
    .search-box input {
      border: none;
      background: transparent;
      font-size: 0.9rem;
    }
    .search-box input:focus {
      outline: none;
    }

    .filter-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    .filter-tab {
      padding: 0.5rem 1.2rem;
      border-radius: 30px;
      background: white;
      border: 1.5px solid #e2e8f0;
      color: #64748b;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .filter-tab.active {
      background: #2563eb;
      color: white;
      border-color: #2563eb;
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .status-card {
      background: #f8fafc;
      border-radius: 16px;
      padding: 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .status-card:hover {
      background: #eff6ff;
      border-color: #2563eb;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: white;
      border-radius: 24px;
      padding: 2rem;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #334155;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 0.8rem;
      border: 1.5px solid #e2e8f0;
      border-radius: 12px;
      font-size: 0.95rem;
    }

    .activity-log {
      max-height: 300px;
      overflow-y: auto;
    }
    .log-item {
      padding: 0.8rem;
      border-bottom: 1px solid #f1f5f9;
      display: flex;
      gap: 0.8rem;
      align-items: center;
    }

    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .login-box {
      background: white;
      border-radius: 20px;
      padding: 3rem;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .login-logo {
      text-align: center;
      margin-bottom: 2rem;
    }

    .login-logo h1 {
      font-size: 2rem;
      color: #1a1a2e;
    }

    .login-logo span {
      color: #667eea;
    }

    .login-form input {
      width: 100%;
      padding: 1rem;
      margin-bottom: 1rem;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 1rem;
    }

    .login-form input:focus {
      border-color: #667eea;
      outline: none;
    }

    .login-btn {
      width: 100%;
      padding: 1rem;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .login-btn:hover {
      background: #5a67d8;
      transform: translateY(-2px);
    }

    @media (max-width: 768px) {
      .sidebar {
        width: 0;
        transform: translateX(-100%);
      }
      .sidebar.show {
        width: 280px;
        transform: translateX(0);
      }
      .main-content {
        margin-left: 0;
      }
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <!-- QR MODAL -->
  <div id="qrModal" class="modal">
    <div class="modal-content">
      <h2 style="margin-bottom: 1.5rem;">Create QR Code</h2>
      <div class="form-group">
        <label>QR Name</label>
        <input type="text" id="qrName" placeholder="e.g., Company Main QR">
      </div>
      <div class="form-group">
        <label>QR Type</label>
        <select id="qrType">
          <option value="company">Company Profile</option>
          <option value="payment">Payment Link</option>
          <option value="job">Job Listing</option>
          <option value="profile">User Profile</option>
          <option value="referral">Referral Link</option>
        </select>
      </div>
      <div class="form-group">
        <label>QR Image</label>
        <div style="display: flex; gap: 1rem; align-items: center;">
          <input type="file" id="qrImageUpload" accept="image/*">
          <button class="btn btn-primary" onclick="uploadQRImage()">Upload</button>
        </div>
        <div id="qrImagePreview" style="margin-top: 1rem; display: none;">
          <img src="" style="max-width: 150px; max-height: 150px; border: 1px solid #e2e8f0; border-radius: 8px;">
        </div>
      </div>
      <div class="form-group">
        <label>Or Enter URL (for auto-generated QR)</label>
        <input type="url" id="qrUrl" placeholder="https://sewalink.com/...">
      </div>
      <div class="form-group">
        <label>Commission Rate (%)</label>
        <input type="number" id="qrCommission" value="10" min="0" max="100">
      </div>
      <div class="form-group">
        <label>QR Code Data (optional)</label>
        <textarea id="qrData" placeholder="Custom data to encode in QR" rows="3"></textarea>
      </div>
      <div style="display: flex; gap: 1rem; justify-content: flex-end;">
        <button class="btn btn-danger" onclick="closeQRModal()">Cancel</button>
        <button class="btn btn-success" onclick="generateQR()">Generate QR</button>
      </div>
    </div>
  </div>

  <!-- CATEGORY MODAL -->
  <div id="categoryModal" class="modal">
    <div class="modal-content">
      <h2 style="margin-bottom: 1.5rem;" id="categoryModalTitle">Add Category</h2>
      <div class="form-group">
        <label>Category Name</label>
        <input type="text" id="categoryName" placeholder="e.g., Web Development">
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea id="categoryDescription" placeholder="Category description..." rows="3"></textarea>
      </div>
      <div class="form-group">
        <label>Commission Rate (%)</label>
        <input type="number" id="categoryCommission" value="10" min="0" max="100">
      </div>
      <div class="form-group">
        <label>Icon (Font Awesome class)</label>
        <input type="text" id="categoryIcon" value="fa-briefcase" placeholder="e.g., fa-code">
      </div>
      <div class="form-group">
        <label>Color</label>
        <input type="color" id="categoryColor" value="#2563eb">
      </div>
      <div style="display: flex; gap: 1rem; justify-content: flex-end;">
        <button class="btn btn-danger" onclick="closeCategoryModal()">Cancel</button>
        <button class="btn btn-success" onclick="saveCategory()">Save Category</button>
      </div>
    </div>
  </div>

  <!-- COIN MODAL -->
  <div id="coinModal" class="modal">
    <div class="modal-content">
      <h2 style="margin-bottom: 1.5rem;">Manage User Coins</h2>
      <div class="form-group">
        <label>User</label>
        <input type="text" id="coinUserId" readonly style="background: #f1f5f9;">
      </div>
      <div class="form-group">
        <label>Current Coins</label>
        <input type="number" id="currentCoins" readonly style="background: #f1f5f9;">
      </div>
      <div class="form-group">
        <label>Action</label>
        <select id="coinAction">
          <option value="add">Add Coins</option>
          <option value="deduct">Deduct Coins</option>
          <option value="set">Set Exact Amount</option>
        </select>
      </div>
      <div class="form-group">
        <label>Amount</label>
        <input type="number" id="coinAmount" placeholder="Enter amount" min="0">
      </div>
      <div class="form-group">
        <label>Reason</label>
        <input type="text" id="coinReason" placeholder="e.g., Bonus, Penalty, Refund">
      </div>
      <div style="display: flex; gap: 1rem; justify-content: flex-end;">
        <button class="btn btn-danger" onclick="closeCoinModal()">Cancel</button>
        <button class="btn btn-success" onclick="saveCoinChanges()">Update Coins</button>
      </div>
    </div>
  </div>

  <!-- SETTINGS MODAL -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <h2 style="margin-bottom: 1.5rem;">Edit Setting</h2>
      <div class="form-group">
        <label>Setting Key</label>
        <input type="text" id="settingKey" readonly style="background: #f1f5f9;">
      </div>
      <div class="form-group">
        <label>Setting Value</label>
        <input type="text" id="settingValue" placeholder="Enter value">
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea id="settingDescription" placeholder="Setting description..." rows="3"></textarea>
      </div>
      <div style="display: flex; gap: 1rem; justify-content: flex-end;">
        <button class="btn btn-danger" onclick="closeSettingsModal()">Cancel</button>
        <button class="btn btn-success" onclick="saveSetting()">Save Setting</button>
      </div>
    </div>
  </div>

  <!-- BLACKLIST MODAL -->
  <div id="blacklistModal" class="modal">
    <div class="modal-content">
      <h2 style="margin-bottom: 1.5rem;">Add to Blacklist</h2>
      <div class="form-group">
        <label>User Email</label>
        <input type="email" id="blacklistEmail" placeholder="user@example.com">
      </div>
      <div class="form-group">
        <label>Reason</label>
        <textarea id="blacklistReason" placeholder="Reason for banning..." rows="3"></textarea>
      </div>
      <div class="form-group">
        <label>Ban Duration</label>
        <select id="blacklistDuration">
          <option value="permanent">Permanent</option>
          <option value="7">7 Days</option>
          <option value="30">30 Days</option>
          <option value="90">90 Days</option>
        </select>
      </div>
      <div style="display: flex; gap: 1rem; justify-content: flex-end;">
        <button class="btn btn-danger" onclick="closeBlacklistModal()">Cancel</button>
        <button class="btn btn-success" onclick="addToBlacklist()">Add to Blacklist</button>
      </div>
    </div>
  </div>

  <script type="module">
    // ========== FIREBASE IMPORTS ==========
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
      getAuth, 
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      orderBy,
      limit,
      getDocs,
      getDoc,
      doc,
      updateDoc,
      deleteDoc,
      addDoc,
      setDoc,
      serverTimestamp,
      increment,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    // ========== FIREBASE CONFIG ==========
    const firebaseConfig = {
      apiKey: "AIzaSyCVYHKeB4TXobILCAygM8JIVisKqUGiJ1s",
      authDomain: "sewalink-ead02.firebaseapp.com",
      projectId: "sewalink-ead02",
      storageBucket: "sewalink-ead02.firebasestorage.app",
      messagingSenderId: "682952754486",
      appId: "1:682952754486:web:c0bba16496d78234aa1f97"
    };

    // ========== INITIALIZE FIREBASE ==========
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ========== ADMIN STATE ==========
    let currentAdmin = null;
    let adminData = null;
    let currentSection = 'dashboard';
    let qrImageFile = null;

    // ========== DOM ELEMENTS ==========
    const appDiv = document.getElementById('app');

    // ========== HELPER FUNCTIONS ==========
    function formatNPR(amount) {
      return `‡§∞‡•Å ${Number(amount || 0).toLocaleString('en-IN')}`;
    }

    function escapeHTML(str) {
      if (!str) return '';
      return String(str).replace(/[&<>"]/g, function(match) {
        return {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;'
        }[match];
      });
    }

    function showAlert(message, type = 'success') {
      const alertDiv = document.createElement('div');
      alertDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#22c55e' : '#ef4444'};
        color: white;
        padding: 1rem 2rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 9999;
        animation: slideIn 0.3s ease;
      `;
      alertDiv.textContent = message;
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        alertDiv.remove();
      }, 3000);
    }

    // ========== RENDER LOGIN PAGE ==========
    function renderLoginPage() {
      appDiv.innerHTML = `
        <div class="login-container">
          <div class="login-box">
            <div class="login-logo">
              <h1>Sewa<span>Link</span></h1>
              <p style="color: #64748b; margin-top: 0.5rem;">Admin Dashboard</p>
            </div>
            <div class="login-form">
              <input type="email" id="loginEmail" placeholder="Email" value="admin@sewalink.com">
              <input type="password" id="loginPassword" placeholder="Password" value="admin123">
              <button class="login-btn" onclick="handleLogin()">Sign In</button>
            </div>
          </div>
        </div>
      `;
    }

    // ========== HANDLE LOGIN ==========
    window.handleLogin = async function() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        
        // Check if user is admin
        const adminRef = doc(db, 'admins', userCredential.user.uid);
        const adminSnap = await getDoc(adminRef);
        
        if (!adminSnap.exists()) {
          await signOut(auth);
          alert('Access denied. Not an admin account.');
          return;
        }

        showAlert('Login successful!', 'success');
      } catch (error) {
        console.error('Login error:', error);
        alert('Login failed: ' + error.message);
      }
    };

    // ========== ADMIN LOGOUT ==========
    window.adminLogout = async function() {
      await signOut(auth);
    };

    // ========== SHOW SECTION ==========
    window.showSection = async function(section) {
      currentSection = section;
      
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      if (event?.currentTarget) {
        event.currentTarget.classList.add('active');
      }

      const titles = {
        'dashboard': 'Dashboard',
        'admins': 'Admin Manager',
        'audit': 'Audit Logs',
        'qr': 'QR Code Manager',
        'scans': 'Scan Analytics',
        'coins': 'Coin Management',
        'commission': 'Commission Control',
        'transactions': 'Transaction History',
        'withdrawals': 'Withdrawal Requests',
        'users': 'User Management',
        'freelancers': 'Freelancer Management',
        'clients': 'Client Management',
        'jobs': 'Job Management',
        'categories': 'Category Manager',
        'settings': 'Platform Settings',
        'blacklist': 'Blacklist Manager'
      };
      
      document.getElementById('pageTitle').textContent = titles[section] || 'Dashboard';

      try {
        await logAdminActivity(`view_${section}`);
        
        switch(section) {
          case 'dashboard': await loadDashboard(); break;
          case 'coins': await loadCoinManagement(); break;
          case 'qr': await loadQRManager(); break;
          case 'scans': await loadScanAnalytics(); break;
          case 'commission': await loadCommission(); break;
          case 'transactions': await loadTransactions(); break;
          case 'withdrawals': await loadWithdrawals(); break;
          case 'users': await loadUsers(); break;
          case 'freelancers': await loadFreelancers(); break;
          case 'clients': await loadClients(); break;
          case 'jobs': await loadJobs(); break;
          case 'admins': await loadAdminManager(); break;
          case 'audit': await loadAuditLogs(); break;
          case 'categories': await loadCategories(); break;
          case 'settings': await loadSettings(); break;
          case 'blacklist': await loadBlacklist(); break;
          default: await loadDashboard();
        }
      } catch (error) {
        console.error('Error loading section:', error);
        document.getElementById('contentArea').innerHTML = `
          <div style="text-align: center; padding: 4rem;">
            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ef4444;"></i>
            <h3 style="margin-top: 1rem;">Error Loading Section</h3>
            <p style="color: #64748b;">${error.message}</p>
            <button onclick="showSection('${section}')" class="btn btn-primary" style="margin-top: 1rem;">Try Again</button>
          </div>
        `;
      }
    };

    // ========== LOG ADMIN ACTIVITY ==========
    async function logAdminActivity(action, details = {}) {
      if (!currentAdmin) return;
      try {
        await addDoc(collection(db, 'adminLogs'), {
          adminId: currentAdmin.uid,
          email: currentAdmin.email,
          name: adminData?.name || currentAdmin.email,
          action: action,
          details: details,
          timestamp: serverTimestamp()
        });
      } catch (error) {
        console.error('Error logging activity:', error);
      }
    }

    // ========== RENDER ADMIN DASHBOARD ==========
    function renderAdminDashboard() {
      appDiv.innerHTML = `
        <div class="admin-wrapper">
          <!-- SIDEBAR -->
          <div class="sidebar">
            <div class="sidebar-header">
              <a href="#" class="sidebar-logo">
                <i class="fas fa-shield-hal"></i> Sewa<span>Link</span>
              </a>
            </div>

            <div class="admin-info">
              <div class="admin-avatar" id="adminAvatar">${adminData?.name?.charAt(0) || 'A'}</div>
              <div class="admin-details">
                <h4 id="adminName">${adminData?.name || currentAdmin?.email || 'Admin'}</h4>
                <p id="adminRole">${adminData?.role || 'Super Admin'}</p>
              </div>
            </div>

            <div class="sidebar-nav">
              <!-- SECTION A: ADMIN CORE -->
              <div class="nav-section">
                <div class="nav-section-title">üîê ADMIN CORE</div>
                <div class="nav-item active" onclick="showSection('dashboard')">
                  <i class="fas fa-chart-pie"></i> Dashboard
                </div>
                <div class="nav-item" onclick="showSection('admins')">
                  <i class="fas fa-user-shield"></i> Admin Manager
                </div>
                <div class="nav-item" onclick="showSection('audit')">
                  <i class="fas fa-history"></i> Audit Logs
                </div>
              </div>

              <!-- SECTION B: QR CODE MANAGEMENT -->
              <div class="nav-section">
                <div class="nav-section-title">üì± QR CODE</div>
                <div class="nav-item" onclick="showSection('qr')">
                  <i class="fas fa-qrcode"></i> QR Manager
                </div>
                <div class="nav-item" onclick="showSection('scans')">
                  <i class="fas fa-eye"></i> Scan Analytics
                </div>
              </div>

              <!-- SECTION C: PAYMENT & COINS -->
              <div class="nav-section">
                <div class="nav-section-title">üí∞ COINS & PAYMENTS</div>
                <div class="nav-item" onclick="showSection('coins')">
                  <i class="fas fa-coins"></i> Coin Management
                </div>
                <div class="nav-item" onclick="showSection('commission')">
                  <i class="fas fa-percent"></i> Commission Control
                </div>
                <div class="nav-item" onclick="showSection('transactions')">
                  <i class="fas fa-credit-card"></i> All Transactions
                </div>
                <div class="nav-item" onclick="showSection('withdrawals')">
                  <i class="fas fa-money-bill"></i> Withdrawals
                </div>
              </div>

              <!-- SECTION D: USER MANAGEMENT -->
              <div class="nav-section">
                <div class="nav-section-title">üë• USERS</div>
                <div class="nav-item" onclick="showSection('users')">
                  <i class="fas fa-users"></i> All Users
                </div>
                <div class="nav-item" onclick="showSection('freelancers')">
                  <i class="fas fa-briefcase"></i> Freelancers
                </div>
                <div class="nav-item" onclick="showSection('clients')">
                  <i class="fas fa-user-tie"></i> Clients
                </div>
              </div>

              <!-- SECTION E: JOB CONTROL -->
              <div class="nav-section">
                <div class="nav-section-title">üìã JOBS</div>
                <div class="nav-item" onclick="showSection('jobs')">
                  <i class="fas fa-briefcase"></i> All Jobs
                </div>
                <div class="nav-item" onclick="showSection('categories')">
                  <i class="fas fa-tags"></i> Categories
                </div>
              </div>

              <!-- SECTION F: SYSTEM -->
              <div class="nav-section">
                <div class="nav-section-title">‚öôÔ∏è SYSTEM</div>
                <div class="nav-item" onclick="showSection('settings')">
                  <i class="fas fa-gear"></i> Settings
                </div>
                <div class="nav-item" onclick="showSection('blacklist')">
                  <i class="fas fa-ban"></i> Blacklist
                </div>
                <div class="nav-item logout" onclick="adminLogout()">
                  <i class="fas fa-sign-out-alt"></i> Logout
                </div>
              </div>
            </div>
          </div>

          <!-- MAIN CONTENT -->
          <div class="main-content">
            <div class="top-bar">
              <div class="page-title" id="pageTitle">Dashboard</div>
              <div class="top-bar-actions">
                <div class="notification-badge" onclick="showSection('notifications')">
                  <i class="fas fa-bell" style="font-size: 1.2rem; color: #64748b;"></i>
                  <span class="badge" id="notificationCount">0</span>
                </div>
              </div>
            </div>

            <div id="contentArea" class="content-area">
              <div style="display: flex; justify-content: center; align-items: center; height: 400px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #2563eb;"></i>
                <span style="margin-left: 1rem; color: #64748b;">Loading secure dashboard...</span>
              </div>
            </div>
          </div>
        </div>
      `;

      // Load initial dashboard
      showSection('dashboard');
      setupNotifications();
    }

    // ========== SETUP NOTIFICATIONS ==========
    async function setupNotifications() {
      try {
        const withdrawalsQuery = query(
          collection(db, 'withdrawals'),
          where('status', '==', 'pending')
        );
        
        onSnapshot(withdrawalsQuery, (snapshot) => {
          const count = snapshot.size;
          const badge = document.getElementById('notificationCount');
          if (badge) {
            badge.textContent = count;
            badge.style.display = count > 0 ? 'block' : 'none';
          }
        });
      } catch (error) {
        console.error('Notifications error:', error);
      }
    }

    // ========== DASHBOARD ==========
    async function loadDashboard() {
      const contentArea = document.getElementById('contentArea');
      
      contentArea.innerHTML = `<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin"></i> Loading dashboard...</div>`;

      try {
        // Get counts from various collections
        const usersSnapshot = await getDocs(collection(db, 'users'));
        const jobsSnapshot = await getDocs(collection(db, 'jobs'));
        const transactionsSnapshot = await getDocs(collection(db, 'transactions'));
        const categoriesSnapshot = await getDocs(collection(db, 'categories'));
        const qrSnapshot = await getDocs(collection(db, 'qrCodes'));

        let totalCoins = 0;
        let totalRevenue = 0;
        let activeJobs = 0;
        let completedJobs = 0;
        let freelancers = 0;
        let clients = 0;

        usersSnapshot.forEach(doc => {
          const user = doc.data();
          totalCoins += user.coins || 0;
          if (user.role === 'freelancer' || user.role === 'both') freelancers++;
          if (user.role === 'client' || user.role === 'both') clients++;
        });

        jobsSnapshot.forEach(doc => {
          const job = doc.data();
          if (job.status === 'open') activeJobs++;
          if (job.status === 'completed') completedJobs++;
        });

        transactionsSnapshot.forEach(doc => {
          const tx = doc.data();
          if (tx.status === 'completed') {
            totalRevenue += tx.amount || 0;
          }
        });

        // Get pending withdrawals
        const withdrawalsQuery = query(collection(db, 'withdrawals'), where('status', '==', 'pending'));
        const withdrawalsSnapshot = await getDocs(withdrawalsQuery);

        contentArea.innerHTML = `
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-icon"><i class="fas fa-users"></i></div>
                <span class="stat-value">${usersSnapshot.size}</span>
              </div>
              <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-icon"><i class="fas fa-coins"></i></div>
                <span class="stat-value">${totalCoins.toLocaleString()}</span>
              </div>
              <div class="stat-label">Total Coins</div>
            </div>
            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-icon"><i class="fas fa-briefcase"></i></div>
                <span class="stat-value">${jobsSnapshot.size}</span>
              </div>
              <div class="stat-label">Total Jobs</div>
            </div>
            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-icon"><i class="fas fa-tags"></i></div>
                <span class="stat-value">${categoriesSnapshot.size}</span>
              </div>
              <div class="stat-label">Categories</div>
            </div>
          </div>

          <div class="status-grid">
            <div class="status-card" onclick="showSection('users')">
              <i class="fas fa-users" style="font-size: 2rem; color: #3b82f6;"></i>
              <div>
                <h4 style="font-size: 1.2rem;">${usersSnapshot.size}</h4>
                <p style="color: #64748b;">Users</p>
              </div>
            </div>
            <div class="status-card" onclick="showSection('freelancers')">
              <i class="fas fa-briefcase" style="font-size: 2rem; color: #10b981;"></i>
              <div>
                <h4 style="font-size: 1.2rem;">${freelancers}</h4>
                <p style="color: #64748b;">Freelancers</p>
              </div>
            </div>
            <div class="status-card" onclick="showSection('clients')">
              <i class="fas fa-user-tie" style="font-size: 2rem; color: #8b5cf6;"></i>
              <div>
                <h4 style="font-size: 1.2rem;">${clients}</h4>
                <p style="color: #64748b;">Clients</p>
              </div>
            </div>
            <div class="status-card" onclick="showSection('jobs')">
              <i class="fas fa-briefcase" style="font-size: 2rem; color: #f59e0b;"></i>
              <div>
                <h4 style="font-size: 1.2rem;">${activeJobs}</h4>
                <p style="color: #64748b;">Active Jobs</p>
              </div>
            </div>
            <div class="status-card" onclick="showSection('withdrawals')">
              <i class="fas fa-money-bill" style="font-size: 2rem; color: #ef4444;"></i>
              <div>
                <h4 style="font-size: 1.2rem;">${withdrawalsSnapshot.size}</h4>
                <p style="color: #64748b;">Pending Withdrawals</p>
              </div>
            </div>
            <div class="status-card" onclick="showSection('qr')">
              <i class="fas fa-qrcode" style="font-size: 2rem; color: #8b5cf6;"></i>
              <div>
                <h4 style="font-size: 1.2rem;">${qrSnapshot.size}</h4>
                <p style="color: #64748b;">QR Codes</p>
              </div>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
            <div class="table-container">
              <div class="table-header">
                <div class="table-title">Recent Activity</div>
              </div>
              <div id="recentActivity">Loading...</div>
            </div>

            <div class="table-container">
              <div class="table-header">
                <div class="table-title">Quick Actions</div>
              </div>
              <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <button class="btn btn-primary" onclick="showSection('coins')" style="width: 100%;">Manage Coins</button>
                <button class="btn btn-primary" onclick="showSection('categories')" style="width: 100%;">Manage Categories</button>
                <button class="btn btn-primary" onclick="showSection('settings')" style="width: 100%;">Platform Settings</button>
                <button class="btn btn-warning" onclick="showSection('withdrawals')" style="width: 100%;">Pending: ${withdrawalsSnapshot.size}</button>
              </div>
            </div>
          </div>
        `;

        await loadRecentActivity();

      } catch (error) {
        console.error('Dashboard error:', error);
        contentArea.innerHTML = `
          <div style="text-align: center; padding: 4rem;">
            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ef4444;"></i>
            <h3 style="margin-top: 1rem;">Error Loading Dashboard</h3>
            <p style="color: #64748b;">${error.message}</p>
            <button onclick="loadDashboard()" class="btn btn-primary" style="margin-top: 1rem;">Try Again</button>
          </div>
        `;
      }
    }

    // ========== RECENT ACTIVITY ==========
    async function loadRecentActivity() {
      try {
        const logsQuery = query(
          collection(db, 'adminLogs'),
          orderBy('timestamp', 'desc'),
          limit(10)
        );
        const logsSnapshot = await getDocs(logsQuery);
        
        let html = '<div class="activity-log">';
        if (logsSnapshot.empty) {
          html += '<p style="color: #64748b; text-align: center; padding: 1rem;">No recent activity</p>';
        } else {
          logsSnapshot.forEach(doc => {
            const log = doc.data();
            const time = log.timestamp ? new Date(log.timestamp.seconds * 1000).toLocaleString() : 'Unknown';
            html += `
              <div class="log-item">
                <i class="fas fa-circle" style="color: #2563eb; font-size: 0.5rem;"></i>
                <div style="flex:1;">
                  <div style="font-weight: 500;">${log.action || 'Unknown'}</div>
                  <div style="font-size: 0.7rem; color: #64748b;">${time} ‚Ä¢ ${log.email || 'Admin'}</div>
                </div>
              </div>
            `;
          });
        }
        html += '</div>';
        
        document.getElementById('recentActivity').innerHTML = html;
      } catch (error) {
        console.error('Error loading activity:', error);
      }
    }

    // ========== QR CODE MANAGER ==========
    async function loadQRManager() {
      const contentArea = document.getElementById('contentArea');
      
      contentArea.innerHTML = `<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin"></i> Loading QR codes...</div>`;

      try {
        const qrSnapshot = await getDocs(collection(db, 'qrCodes'));
        const qrCodes = [];
        qrSnapshot.forEach(doc => {
          qrCodes.push({ id: doc.id, ...doc.data() });
        });

        contentArea.innerHTML = `
          <div class="qr-section">
            <div class="table-header">
              <div class="table-title">SewaLink QR Code Manager</div>
              <button class="btn btn-primary" onclick="openQRModal()">
                <i class="fas fa-plus"></i> Generate New QR
              </button>
            </div>

            <div class="qr-grid">
              ${qrCodes.map(qr => `
                <div class="qr-card">
                  <h3>${escapeHTML(qr.name || 'QR Code')}</h3>
                  <div class="qr-preview">
                    <img src="${qr.qrImage || qr.url || 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=SewaLink'}" 
                         onerror="this.src='https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=SewaLink'">
                  </div>
                  <div style="margin: 0.5rem 0;">
                    <span class="badge badge-info">${qr.type || 'company'}</span>
                    <span class="badge badge-success">${qr.scans || 0} scans</span>
                  </div>
                  <div style="font-size: 0.8rem; color: #64748b; margin-bottom: 1rem;">
                    Commission: ${qr.commission || 10}%
                  </div>
                  <div class="qr-actions">
                    <button class="btn btn-info btn-sm" onclick="downloadQR('${qr.id}')">
                      <i class="fas fa-download"></i>
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="editQR('${qr.id}')">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteQR('${qr.id}')">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
              `).join('')}
              
              ${qrCodes.length === 0 ? `
                <div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: #64748b;">
                  <i class="fas fa-qrcode" style="font-size: 3rem;"></i>
                  <p style="margin-top: 1rem;">No QR codes yet. Create your first one!</p>
                </div>
              ` : ''}
            </div>
          </div>

          <div class="table-container">
            <div class="table-header">
              <div class="table-title">QR Scan Analytics</div>
            </div>
            <table>
              <thead>
                <tr>
                  <th>QR Code</th>
                  <th>Total Scans</th>
                  <th>Unique Users</th>
                  <th>Last Scan</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${qrCodes.map(qr => `
                  <tr>
                    <td>${escapeHTML(qr.name || 'QR Code')}</td>
                    <td>${qr.scans || 0}</td>
                    <td>${qr.uniqueUsers || 0}</td>
                    <td>${qr.lastScan ? new Date(qr.lastScan.seconds * 1000).toLocaleDateString() : 'Never'}</td>
                    <td>
                      <button class="btn btn-info btn-sm" onclick="viewQRScans('${qr.id}')">View Details</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      } catch (error) {
        console.error('QR error:', error);
        contentArea.innerHTML = `<div style="color: #ef4444; padding: 2rem;">Error: ${error.message}</div>`;
      }
    }

    // ========== UPLOAD QR IMAGE ==========
    window.uploadQRImage = async function() {
      const file = document.getElementById('qrImageUpload').files[0];
      if (!file) {
        alert('Please select an image');
        return;
      }

      try {
        const storageRef = ref(storage, `qr-codes/${Date.now()}_${file.name}`);
        await uploadBytes(storageRef, file);
        const url = await getDownloadURL(storageRef);
        
        document.getElementById('qrUrl').value = url;
        
        const preview = document.getElementById('qrImagePreview');
        preview.style.display = 'block';
        preview.innerHTML = `<img src="${url}" style="max-width: 150px; max-height: 150px;">`;
        
        showAlert('Image uploaded successfully!', 'success');
      } catch (error) {
        console.error('Upload error:', error);
        showAlert('Upload failed: ' + error.message, 'error');
      }
    };

    // ========== QR MODAL FUNCTIONS ==========
    window.openQRModal = function() {
      document.getElementById('qrModal').classList.add('active');
      document.getElementById('qrName').value = '';
      document.getElementById('qrUrl').value = '';
      document.getElementById('qrCommission').value = '10';
      document.getElementById('qrData').value = '';
      document.getElementById('qrImagePreview').style.display = 'none';
      document.getElementById('qrImagePreview').innerHTML = '';
    };

    window.closeQRModal = function() {
      document.getElementById('qrModal').classList.remove('active');
    };

    window.generateQR = async function() {
      const name = document.getElementById('qrName').value;
      const type = document.getElementById('qrType').value;
      const url = document.getElementById('qrUrl').value;
      const commission = document.getElementById('qrCommission').value;
      const customData = document.getElementById('qrData').value;

      if (!name) {
        alert('Please enter QR name');
        return;
      }

      try {
        // Generate QR code using QR Server API
        const qrData = customData || `https://sewalink.com/${type}/${name.toLowerCase().replace(/\s+/g, '-')}`;
        const qrImageUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrData)}`;

        const qrCode = {
          name: name,
          type: type,
          url: url || qrImageUrl,
          qrImage: qrImageUrl,
          data: qrData,
          commission: parseInt(commission),
          scans: 0,
          uniqueUsers: 0,
          createdAt: serverTimestamp(),
          createdBy: currentAdmin?.uid,
          createdByName: adminData?.name || currentAdmin?.email
        };

        await addDoc(collection(db, 'qrCodes'), qrCode);
        
        await logAdminActivity('qr_generated', { name, type });
        
        showAlert('QR Code generated successfully!', 'success');
        closeQRModal();
        
        await loadQRManager();
        
      } catch (error) {
        console.error('Error generating QR:', error);
        showAlert('Error: ' + error.message, 'error');
      }
    };

    window.deleteQR = async function(qrId) {
      if (!confirm('Are you sure you want to delete this QR code?')) return;
      
      try {
        await deleteDoc(doc(db, 'qrCodes', qrId));
        await logAdminActivity('qr_deleted', { qrId });
        showAlert('QR code deleted', 'success');
        await loadQRManager();
      } catch (error) {
        showAlert('Error: ' + error.message, 'error');
      }
    };

    window.downloadQR = function(qrId) {
      // Find QR code and download
      showAlert('Download feature coming soon', 'info');
    };

    window.editQR = function(qrId) {
      showAlert('Edit feature coming soon', 'info');
    };

    // ========== SCAN ANALYTICS ==========
    async function loadScanAnalytics() {
      const contentArea = document.getElementById('contentArea');
      
      try {
        const scansSnapshot = await getDocs(collection(db, 'qrScans'));
        const scans = [];
        scansSnapshot.forEach(doc => {
          scans.push({ id: doc.id, ...doc.data() });
        });

        // Group scans by QR code
        const grouped = {};
        scans.forEach(scan => {
          if (!grouped[scan.qrId]) {
            grouped[scan.qrId] = [];
          }
          grouped[scan.qrId].push(scan);
        });

        contentArea.innerHTML = `
          <div class="table-container">
            <div class="table-header">
              <div class="table-title">Scan Analytics (${scans.length} total scans)</div>
            </div>
            <table>
              <thead>
                <tr>
                  <th>QR Code</th>
                  <th>Scans</th>
                  <th>Unique Users</th>
                  <th>Last 24h</th>
                  <th>Conversion</th>
                </tr>
              </thead>
              <tbody>
                ${Object.entries(grouped).map(([qrId, qrScans]) => {
                  const last24h = qrScans.filter(s => {
                    const scanTime = s.timestamp?.seconds * 1000;
                    const dayAgo = Date.now() - 24*60*60*1000;
                    return scanTime > dayAgo;
                  }).length;
                  const uniqueUsers = new Set(qrScans.map(s => s.userId)).size;
                  const converted = qrScans.filter(s => s.converted).length;
                  
                  return `
                    <tr>
                      <td>${qrId.substring(0, 8)}...</td>
                      <td>${qrScans.length}</td>
                      <td>${uniqueUsers}</td>
                      <td>${last24h}</td>
                      <td>${Math.round((converted / qrScans.length) * 100) || 0}%</td>
                    </tr>
                  `;
                }).join('')}
                ${Object.keys(grouped).length === 0 ? '<tr><td colspan="5" style="text-align: center; padding: 2rem;">No scan data yet</td></tr>' : ''}
              </tbody>
            </table>
          </div>
        `;
      } catch (error) {
        console.error('Error loading scans:', error);
      }
    }

    // ========== COIN MANAGEMENT ==========
    async function loadCoinManagement() {
      const contentArea = document.getElementById('contentArea');
      
      contentArea.innerHTML = `<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin"></i> Loading coin data...</div>`;

      try {
        const usersSnapshot = await getDocs(collection(db, 'users'));
        let totalCoins = 0;
        let topUsers = [];
        
        const users = [];
        for (const doc of usersSnapshot.docs) {
          const user = { id: doc.id, ...doc.data() };
          totalCoins += user.coins || 0;
          users.push(user);
          
          if (user.coins > 0) {
            topUsers.push(user);
          }
        }
        
        topUsers.sort((a, b) => (b.coins || 0) - (a.coins || 0));
        topUsers = topUsers.slice(0, 5);

        const coinTxQuery = query(
          collection(db, 'coinTransactions'),
          orderBy('timestamp', 'desc'),
          limit(50)
        );
        const coinTxSnapshot = await getDocs(coinTxQuery);
        const coinTransactions = [];
        coinTxSnapshot.forEach(doc => {
          coinTransactions.push({ id: doc.id, ...doc.data() });
        });

        contentArea.innerHTML = `
          <div class="coin-section">
            <div class="coin-header">
              <h2><i class="fas fa-coins"></i> Coin Management</h2>
              <div class="total-coins">${totalCoins.toLocaleString()}</div>
            </div>
            
            <div class="coin-stats">
              <div class="coin-stat">
                <div class="coin-stat-value">${users.length}</div>
                <div class="coin-stat-label">Users with Coins</div>
              </div>
              <div class="coin-stat">
                <div class="coin-stat-value">${(totalCoins / users.length || 0).toFixed(0)}</div>
                <div class="coin-stat-label">Avg Coins/User</div>
              </div>
              <div class="coin-stat">
                <div class="coin-stat-value">${topUsers[0]?.coins || 0}</div>
                <div class="coin-stat-label">Highest Balance</div>
              </div>
            </div>

            <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 1rem;">
              <h3 style="margin-bottom: 1rem;">Top Coin Holders</h3>
              <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                ${topUsers.map((user, index) => `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: rgba(255,255,255,0.1); border-radius: 8px;">
                    <div>
                      <span style="font-weight: 600;">${index + 1}.</span>
                      <span>${escapeHTML(user.displayName || user.email || 'User')}</span>
                    </div>
                    <div style="font-weight: 700;">${(user.coins || 0).toLocaleString()} coins</div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>

          <div class="table-container">
            <div class="table-header">
              <div class="table-title">All Users Coin Balances</div>
              <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="coinSearch" placeholder="Search users..." onkeyup="searchCoinUsers()">
              </div>
            </div>
            <table>
              <thead>
                <tr>
                  <th>User</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Coins</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="coinUsersTable">
                ${users.map(user => `
                  <tr class="coin-user-row">
                    <td>
                      <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <img src="${user.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.displayName || 'User') + '&background=2563eb&color=fff&size=32'}" style="width: 32px; height: 32px; border-radius: 50%;">
                        <span style="font-weight: 600;">${escapeHTML(user.displayName || 'User')}</span>
                      </div>
                    </td>
                    <td>${escapeHTML(user.email || 'N/A')}</td>
                    <td><span class="badge badge-info">${user.role || 'user'}</span></td>
                    <td><span style="font-weight: 700; color: #f59e0b;">${(user.coins || 0).toLocaleString()}</span></td>
                    <td>
                      <button class="btn btn-primary btn-sm" onclick="openCoinModal('${user.id}', '${escapeHTML(user.displayName || user.email || 'User')}', ${user.coins || 0})">
                        <i class="fas fa-coins"></i> Manage Coins
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>

          <div class="table-container">
            <div class="table-header">
              <div class="table-title">Recent Coin Transactions</div>
            </div>
            <table>
              <thead>
                <tr>
                  <th>User</th>
                  <th>Type</th>
                  <th>Amount</th>
                  <th>New Balance</th>
                  <th>Reason</th>
                  <th>Admin</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                ${coinTransactions.map(tx => {
                  const time = tx.timestamp ? new Date(tx.timestamp.seconds * 1000).toLocaleString() : 'Unknown';
                  return `
                    <tr>
                      <td>${escapeHTML(tx.userName || tx.userId?.substring(0, 8) || 'Unknown')}</td>
                      <td><span class="badge badge-${tx.type === 'add' ? 'success' : tx.type === 'deduct' ? 'danger' : 'info'}">${tx.type}</span></td>
                      <td style="color: ${tx.type === 'add' ? '#22c55e' : tx.type === 'deduct' ? '#ef4444' : '#3b82f6'}; font-weight: 600;">
                        ${tx.type === 'add' ? '+' : tx.type === 'deduct' ? '-' : ''}${tx.amount}
                      </td>
                      <td>${tx.newBalance}</td>
                      <td>${tx.reason || '‚Äî'}</td>
                      <td>${escapeHTML(tx.adminName || tx.adminId?.substring(0, 8) || 'System')}</td>
                      <td>${time}</td>
                    </tr>
                  `;
                }).join('')}
                ${coinTransactions.length === 0 ? '<tr><td colspan="7" style="text-align: center; padding: 2rem;">No coin transactions yet</td></tr>' : ''}
              </tbody>
            </table>
          </div>
        `;
      } catch (error) {
        console.error('Error loading coin management:', error);
        contentArea.innerHTML = `<div style="color: #ef4444; padding: 2rem;">Error: ${error.message}</div>`;
      }
    }

    // ========== COIN MODAL FUNCTIONS ==========
    window.openCoinModal = function(userId, userName, currentCoins) {
      document.getElementById('coinUserId').value = `${userName} (${userId})`;
      document.getElementById('currentCoins').value = currentCoins;
      document.getElementById('coinUserId').dataset.userId = userId;
      document.getElementById('coinAmount').value = '';
      document.getElementById('coinReason').value = '';
      document.getElementById('coinModal').classList.add('active');
    };

    window.closeCoinModal = function() {
      document.getElementById('coinModal').classList.remove('active');
    };

    window.saveCoinChanges = async function() {
      const userId = document.getElementById('coinUserId').dataset.userId;
      const action = document.getElementById('coinAction').value;
      const amount = parseInt(document.getElementById('coinAmount').value);
      const reason = document.getElementById('coinReason').value;
      const currentCoins = parseInt(document.getElementById('currentCoins').value);

      if (!amount || amount <= 0) {
        alert('Please enter a valid amount');
        return;
      }

      if (!reason) {
        alert('Please enter a reason');
        return;
      }

      try {
        const userRef = doc(db, 'users', userId);
        const userSnap = await getDoc(userRef);
        const userData = userSnap.data();
        
        let newCoins = currentCoins;
        let operation = '';

        switch(action) {
          case 'add':
            newCoins = currentCoins + amount;
            operation = 'add';
            break;
          case 'deduct':
            if (currentCoins < amount) {
              alert('Insufficient coins! User only has ' + currentCoins + ' coins');
              return;
            }
            newCoins = currentCoins - amount;
            operation = 'deduct';
            break;
          case 'set':
            newCoins = amount;
            operation = 'set';
            break;
        }

        await updateDoc(userRef, {
          coins: newCoins,
          updatedAt: serverTimestamp()
        });

        await addDoc(collection(db, 'coinTransactions'), {
          userId: userId,
          userName: userData.displayName || userData.email || 'User',
          type: operation,
          amount: amount,
          oldBalance: currentCoins,
          newBalance: newCoins,
          reason: reason,
          adminId: currentAdmin.uid,
          adminName: adminData?.name || currentAdmin.email,
          timestamp: serverTimestamp()
        });

        await logAdminActivity('coin_updated', {
          userId,
          action: operation,
          amount,
          oldBalance: currentCoins,
          newBalance: newCoins,
          reason
        });

        showAlert(`‚úÖ Coins updated successfully! New balance: ${newCoins} coins`, 'success');
        closeCoinModal();
        
        await loadCoinManagement();

      } catch (error) {
        console.error('Error updating coins:', error);
        showAlert('Error: ' + error.message, 'error');
      }
    };

    window.searchCoinUsers = function() {
      const searchTerm = document.getElementById('coinSearch')?.value.toLowerCase() || '';
      const rows = document.querySelectorAll('.coin-user-row');
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? 'table-row' : 'none';
      });
    };

    // ========== APPROVE COIN PURCHASE ==========
    window.approveCoinPurchase = async function(transactionId, userId, coins) {
      if (!confirm('Approve this coin purchase? Coins will be added to user account.')) return;
      
      try {
        const txRef = doc(db, 'transactions', transactionId);
        const txSnap = await getDoc(txRef);
        const tx = txSnap.data();
        
        await updateDoc(txRef, {
          status: 'completed',
          approvedAt: serverTimestamp(),
          approvedBy: currentAdmin?.uid
        });

        const userRef = doc(db, 'users', userId);
        const userSnap = await getDoc(userRef);
        const currentCoins = userSnap.data().coins || 0;
        
        await updateDoc(userRef, {
          coins: currentCoins + coins
        });

        await addDoc(collection(db, 'coinTransactions'), {
          userId: userId,
          userName: tx.userName,
          type: 'purchase',
          amount: coins,
          oldBalance: currentCoins,
          newBalance: currentCoins + coins,
          reason: `Coin purchase approved - ‡§∞‡•Å ${tx.amount}`,
          adminId: currentAdmin.uid,
          adminName: adminData?.name || currentAdmin.email,
          transactionId: transactionId,
          timestamp: serverTimestamp()
        });

        await logAdminActivity('coin_purchase_approved', { 
          transactionId, 
          userId, 
          coins,
          amount: tx.amount 
        });
        
        showAlert(`‚úÖ Purchase approved! ${coins} coins added to user.`, 'success');
        
        await loadTransactions();

      } catch (error) {
        console.error('Error approving purchase:', error);
        showAlert('Error: ' + error.message, 'error');
      }
    };

    // ========== REJECT COIN PURCHASE ==========
    window.rejectCoinPurchase = async function(transactionId, userId, coins) {
      if (!confirm('Reject this coin purchase? No coins will be added.')) return;
      
      try {
        const txRef = doc(db, 'transactions', transactionId);
        const txSnap = await getDoc(txRef);
        const tx = txSnap.data();
        
        await updateDoc(txRef, {
          status: 'rejected',
          rejectedAt: serverTimestamp(),
          rejectedBy: currentAdmin?.uid,
          rejectionReason: 'Admin rejected'
        });

        await addDoc(collection(db, 'coinTransactions'), {
          userId: userId,
          userName: tx.userName,
          type: 'rejection',
          amount: coins,
          reason: `Coin purchase rejected - ‡§∞‡•Å ${tx.amount}`,
          adminId: currentAdmin.uid,
          adminName: adminData?.name || currentAdmin.email,
          transactionId: transactionId,
          timestamp: serverTimestamp()
        });

        await logAdminActivity('coin_purchase_rejected', { 
          transactionId, 
          userId, 
          coins,
          amount: tx.amount 
        });
        
        showAlert(`‚ùå Purchase rejected. No coins added.`, 'success');
        
        await loadTransactions();

      } catch (error) {
        console.error('Error rejecting purchase:', error);
        showAlert('Error: ' + error.message, 'error');
      }
    };

    // ========== COMMISSION CONTROL ==========
    async function loadCommission() {
      const contentArea = document.getElementById('contentArea');

      try {
        let commission = 10;
        try {
          const settingsDoc = await getDoc(doc(db, 'settings', 'commission'));
          if (settingsDoc.exists()) {
            commission = settingsDoc.data().rate || 10;
          }
        } catch (e) {}

        contentArea.innerHTML = `
          <div class="payment-section">
            <div class="table-header">
              <div class="table-title">Platform Commission Settings</div>
            </div>

            <div class="commission-slider">
              <div style="flex: 1;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Commission Rate: <span id="commissionValue">${commission}</span>%</label>
                <input type="range" id="commissionSlider" min="0" max="50" value="${commission}" oninput="updateCommissionValue(this.value)" style="width: 100%;">
              </div>
              <button class="btn btn-success" onclick="saveCommission()">Save Changes</button>
            </div>

            <div class="table-container" style="margin-top: 2rem;">
              <div class="table-header">
                <div class="table-title">Category Commission Overrides</div>
              </div>
              <table>
                <thead>
                  <tr>
                    <th>Category</th>
                    <th>Default Commission</th>
                    <th>Override</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="categoryCommissionTable">
                  <tr>
                    <td colspan="4" style="text-align: center; padding: 2rem;">Loading categories...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        `;

        await loadCategoryCommissionTable();

      } catch (error) {
        console.error('Error loading commission:', error);
      }
    }

    async function loadCategoryCommissionTable() {
      try {
        const categoriesSnapshot = await getDocs(collection(db, 'categories'));
        const categories = [];
        categoriesSnapshot.forEach(doc => {
          categories.push({ id: doc.id, ...doc.data() });
        });

        let html = '';
        categories.forEach(cat => {
          html += `
            <tr>
              <td>${escapeHTML(cat.name)}</td>
              <td>${cat.commission || 10}%</td>
              <td>
                <input type="number" id="cat_${cat.id}" value="${cat.commission || 10}" min="0" max="100" style="width: 80px; padding: 0.3rem;">
              </td>
              <td>
                <button class="btn btn-primary btn-sm" onclick="saveCategoryCommission('${cat.id}')">Save</button>
              </td>
            </tr>
          `;
        });

        if (categories.length === 0) {
          html = '<tr><td colspan="4" style="text-align: center; padding: 2rem;">No categories found</td></tr>';
        }

        document.getElementById('categoryCommissionTable').innerHTML = html;

      } catch (error) {
        console.error('Error loading category commission:', error);
      }
    }

    window.updateCommissionValue = function(value) {
      document.getElementById('commissionValue').textContent = value;
    };

    window.saveCommission = async function() {
      const rate = parseInt(document.getElementById('commissionSlider').value);
      
      try {
        await setDoc(doc(db, 'settings', 'commission'), {
          rate: rate,
          updatedAt: serverTimestamp(),
          updatedBy: currentAdmin?.uid
        }, { merge: true });
        
        await logAdminActivity('commission_updated', { rate });
        showAlert('Commission settings saved!', 'success');
      } catch (error) {
        showAlert('Error: ' + error.message, 'error');
      }
    };

    window.saveCategoryCommission = async function(categoryId) {
      const rate = parseInt(document.getElementById(`cat_${categoryId}`).value);
      
      try {
        await updateDoc(doc(db, 'categories', categoryId), {
          commission: rate
        });
        
        showAlert('Category commission updated!', 'success');
      } catch (error) {
        showAlert('Error: ' + error.message, 'error');
      }
    };

    // ========== TRANSACTIONS ==========
    async function loadTransactions() {
      const contentArea = document.getElementById('contentArea');
      
      contentArea.innerHTML = `<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin"></i> Loading transactions...</div>`;

      try {
        const txQuery = query(
          collection(db, 'transactions'),
          orderBy('timestamp', 'desc'),
          limit(100)
        );
        
        const txSnapshot = await getDocs(txQuery);
        const transactions = [];
        let totalRevenue = 0;
        
        txSnapshot.forEach(doc => {
          const tx = { id: doc.id, ...doc.data() };
          transactions.push(tx);
          if (tx.status === 'completed') {
            totalRevenue += tx.amount || 0;
          }
        });

        contentArea.innerHTML = `
          <div class="table-container">
            <div class="table-header">
              <div class="table-title">All Transactions (${transactions.length})</div>
              <div style="font-weight: 600;">Total Revenue: ${formatNPR(totalRevenue)}</div>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Transaction ID</th>
                  <th>User</th>
                  <th>Type</th>
                  <th>Amount</th>
                  <th>Coins</th>
                  <th>Status</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${transactions.map(tx => {
                  const time = tx.timestamp ? new Date(tx.timestamp.seconds * 1000).toLocaleString() : 'Unknown';
                  
                  return `
                    <tr>
                      <td>${tx.id.substring(0, 8)}...</td>
                      <td>${escapeHTML(tx.userName || tx.userId?.substring(0, 8) || 'Unknown')}</td>
                      <td><span class="badge badge-${tx.type === 'purchase' ? 'success' : 'warning'}">${tx.type || 'unknown'}</span></td>
                      <td>${formatNPR(tx.amount)}</td>
                      <td>${tx.coins || 0}</td>
                      <td><span class="badge badge-${tx.status === 'completed' ? 'success' : tx.status === 'rejected' ? 'danger' : 'warning'}">${tx.status || 'pending'}</span></td>
                      <td>${time}</td>
                      <td>
                        ${tx.status === 'pending' && tx.type === 'purchase' ? `
                          <button class="btn btn-success btn-sm" onclick="approveCoinPurchase('${tx.id}', '${tx.userId}', ${tx.coins})">Approve</button>
                          <button class="btn btn-danger btn-sm" onclick="rejectCoinPurchase('${tx.id}', '${tx.userId}', ${tx.coins})">Reject</button>
                        ` : ''}
                      </td>
                    </tr>
                  `;
                }).join('')}
                ${transactions.length === 0 ? '<tr><td colspan="8" style="text-align: center; padding: 2rem;">No transactions yet</td></tr>' : ''}
              </tbody>
            </table>
          </div>
        `;

      } catch (error) {
        console.error('Error loading transactions:', error);
      }
    }

    // ========== WITHDRAWALS ==========
    async function loadWithdrawals() {
      const contentArea = document.getElementById('contentArea');
      
      try {
        const withdrawalsQuery = query(
          collection(db, 'withdrawals'),
          orderBy('createdAt', 'desc')
        );
        const withdrawalsSnapshot = await getDocs(withdrawalsQuery);
        const withdrawals = [];
        withdrawalsSnapshot.forEach(doc => {
          withdrawals.push({ id: doc.id, ...doc.data() });
        });

        contentArea.innerHTML = `
          <div class="table-container">
            <div class="table-header">
              <div class="table-title">Withdrawal Requests (${withdrawals.length})</div>
            </div>
            <table>
              <thead>
                <tr>
                  <th>User</th>
                  <th>Amount</th>
                  <th>Coins</th>
                  <th>eSewa</th>
                  <th>Status</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${withdrawals.map(w => {
                  const time = w.createdAt ? new Date(w.createdAt.seconds * 1000).toLocaleString() : 'Unknown';
                  return `
                    <tr>
                      <td>${escapeHTML(w.userName || w.userId?.substring(0, 8) || 'Unknown')}</td>
                      <td>${formatNPR(w.amount)}</td>
                      <td>${w.coins || 0}</td>
                      <td>${w.esewaNumber || 'N/A'}</td>
                      <td><span class="badge badge-${w.status === 'pending' ? 'warning' : w.status === 'completed' ? 'success' : 'danger'}">${w.status || 'pending'}</span></td>
                      <td>${time}</td>
                      <td>
                        ${w.status === 'pending' ? `
                          <button class="btn btn-success btn-sm" onclick="approveWithdrawal('${w.id}', '${w.userId}', ${w.coins})">Approve</button>
                          <button class="btn btn-danger btn-sm" onclick="rejectWithdrawal('${w.id}', '${w.userId}', ${w.coins})">Reject</button>
                        ` : ''}
                      </td>
                    </tr>
                  `;
                }).join('')}
                ${withdrawals.length === 0 ? '<tr><td colspan="7" style="text-align: center; padding: 2rem;">No withdrawal requests</td></tr>' : ''}
              </tbody>
            </table>
          </div>
        `;
      } catch (error) {
        console.error('Error loading withdrawals:', error);
      }
    }

    window.approveWithdrawal = async function(withdrawalId, userId, coins) {
      if (!confirm('Approve this withdrawal?')) return;
      
      try {
        await updateDoc(doc(db, 'withdrawals', withdrawalId), {
          status: 'completed',
          approvedAt: serverTimestamp(),
          approvedBy: currentAdmin?.uid
        });
        
        await logAdminActivity('withdrawal_approved', { withdrawalId, coins });
        showAlert('Withdrawal approved', 'success');
        await loadWithdrawals();
      } catch (error) {
        showAlert('Error: ' + error.message, 'error');
      }
    };

    window.rejectWithdrawal = async function(withdrawalId, userId, coins) {
      if (!confirm('Reject this withdrawal? Coins will be refunded.')) return;
      
      try {
        const withdrawalRef = doc(db, 'withdrawals', withdrawalId);
        const withdrawalSnap = await getDoc(withdrawalRef);
        const withdrawal = withdrawalSnap.data();
        
        await updateDoc(withdrawalRef, {
          status: 'rejected',
          rejectedAt: serverTimestamp(),
          rejectedBy: currentAdmin?.uid
        });

        const userRef = doc(db, 'users', userId);
        const userSnap = await getDoc(userRef);
        const currentCoins = userSnap.data().coins || 0;
        
        await updateDoc(userRef, {
          coins: currentCoins + coins
        });

        await addDoc(collection(db, 'coinTransactions'), {
          userId: userId,
          userName: withdrawal.userName,
          type: 'refund',
          amount: coins,
          oldBalance: currentCoins,
          newBalance: currentCoins + coins,
          reason: 'Withdrawal rejected',
          adminId: currentAdmin.uid,
          adminName: adminData?.name || currentAdmin.email,
          timestamp: serverTimestamp()
        });
        
        await logAdminActivity('withdrawal_rejected', { withdrawalId, coins });
        showAlert('Withdrawal rejected and coins refunded', 'success');
        await loadWithdrawals();
      } catch (error) {
        showAlert('Error: ' + error.message, 'error');
      }
    };

    // ========== USERS MANAGEMENT ==========
    async function loadUsers() {
      const contentArea = document.getElementById('contentArea');
      
      contentArea.innerHTML = `<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin"></i> Loading users...</div>`;

      try {
        const usersSnapshot = await getDocs(collection(db, 'users'));
        const users = [];
        usersSnapshot.forEach(doc => {
          users.push({ id: doc.id, ...doc.data() });
        });

        contentArea.innerHTML = `
          <div class="table-container">
            <div class="table-header">
              <div class="table-title">All Users (${users.length})</div>
              <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="userSearch" placeholder="Search users..." onkeyup="searchUsers()">
              </div>
            </div>
            <table>
              <thead>
                <tr>
                  <th>User</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Coins</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
                ${users.map(user => `
                  <tr class="user-row">
                    <td>
                      <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <img src="${user.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.displayName || 'User') + '&background=2563eb&color=fff&size=32'}" style="width: 32px; height: 32px; border-radius: 50%;">
                        <span style="font-weight: 600;">${escapeHTML(user.displayName || 'User')}</span>
                      </div>
                    </td>
                    <td>${escapeHTML(user.email || 'N/A')}</td>
                    <td><span class="badge badge-info">${user.role || 'user'}</span></td>
                    <td><span style="color: #f59e0b; font-weight: 600;">${(user.coins || 0).toLocaleString()}</span></td>
                    <td><span class="badge badge-${user.status === 'banned' ? 'danger' : 'success'}">${user.status || 'active'}</span></td>
                    <td>
                      <button class="btn btn-primary btn-sm" onclick="viewUser('${user.id}')">View</button>
                      <button class="btn btn-warning btn-sm" onclick="openCoinModal('${user.id}', '${escapeHTML(user.displayName || user.email || 'User')}', ${user.coins || 0})">
                        <i class="fas fa-coins"></i> Coins
                      </button>
                      ${user.status !== 'banned' ? `
                        <button class="btn btn-danger btn-sm" onclick="banUser('${user.id}')">Ban</button>
                      ` : `
                        <button class="btn btn-success btn-sm" onclick="unbanUser('${user.id}')">Unban</button>
                      `}
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      } catch (error) {
        console.error('Error loading users:', error);
        contentArea.innerHTML = `<div style="color: #ef4444; padding: 2rem;">Error: ${error.message}</div>`;
      }
    }

    // ========== FREELANCERS ==========
    async function loadFreelancers() {
      const contentArea = document.getElementById('contentArea');
      
      try {
        const usersRef = collection(db, 'users');
        const q = query(usersRef, where('role', 'in', ['freelancer', 'both']));
        const snapshot = await getDocs(q);
        const freelancers = [];
        
        for (const doc of snapshot.docs) {
          const freelancer = { id: doc.id, ...doc.data() };
          
          try {
            const jobsRef = collection(db, 'jobs');
            const completedJobsQuery = query(
              jobsRef,
              where('acceptedBy', '==', doc.id),
              where('status', '==', 'completed')
            );
            const completedSnapshot = await getDocs(completedJobsQuery);
            freelancer.completedJobs = completedSnapshot.size;
            
            let earnings = 0;
            completedSnapshot.forEach(job => {
              earnings += job.data().budget || 0;
            });
            freelancer.earnings = earnings;
          } catch (e) {
            freelancer.completedJobs = 0;
            freelancer.earnings = 0;
          }
          
          freelancers.push(freelancer);
        }

        contentArea.innerHTML = `
          <div class="table-container">
            <div class="table-header">
              <div class="table-title">Freelancers (${freelancers.length})</div>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Freelancer</th>
                  <th>Email</th>
                  <th>Skills</th>
                  <th>Coins</th>
                  <th>Completed</th>
                  <th>Earnings</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${freelancers.map(f => `
                  <tr>
                    <td>
                      <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <img src="${f.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(f.displayName || 'Freelancer') + '&background=2563eb&color=fff&size=32'}" style="width: 32px; height: 32px; border-radius: 50%;">
                        <span style="font-weight: 600;">${escapeHTML(f.displayName || 'Freelancer')}</span>
                      </div>
                    </td>
                    <td>${escapeHTML(f.email || 'N/A')}</td>
                    <td>${(f.skills || []).slice(0, 3).join(', ') || '‚Äî'}</td>
                    <td><span style="color: #f59e0b; font-weight: 600;">${(f.coins || 0).toLocaleString()}</span></td>
                    <td>${f.completedJobs || 0}</td>
                    <td>${formatNPR(f.earnings)}</td>
                    <td>
                      <button class="btn btn-primary btn-sm" onclick="viewUser('${f.id}')">View</button>
                      <button class="btn btn-warning btn-sm" onclick="openCoinModal('${f.id}', '${escapeHTML(f.displayName || f.email || 'Freelancer')}', ${f.coins || 0})">
                        <i class="fas fa-coins"></i> Coins
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      } catch (error) {
        console.error('Error loading freelancers:', error);
        contentArea.innerHTML = `<div style="color: #ef4444; padding: 2rem;">Error: ${error.message}</div>`;
      }
    }

    // ========== CLIENTS ==========
    async function loadClients() {
      const contentArea = document.getElementById('contentArea');
      
      try {
        const usersRef = collection(db, 'users');
        const q = query(usersRef, where('role', 'in', ['client', 'both']));
        const snapshot = await getDocs(q);
        const clients = [];
        
        for (const doc of snapshot.docs) {
          const client = { id: doc.id, ...doc.data() };
          
          try {
            const jobsRef = collection(db, 'jobs');
            const jobsQuery = query(jobsRef, where('clientId', '==', doc.id));
            const jobsSnapshot = await getDocs(jobsQuery);
            client.postedJobs = jobsSnapshot.size;
            
            let spent = 0;
            jobsSnapshot.forEach(job => {
              if (job.data().status === 'completed') {
                spent += job.data().budget || 0;
              }
            });
            client.spent = spent;
          } catch (e) {
            client.postedJobs = 0;
            client.spent = 0;
          }
          
          clients.push(client);
        }

        contentArea.innerHTML = `
          <div class="table-container">
            <div class="table-header">
              <div class="table-title">Clients (${clients.length})</div>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Client</th>
                  <th>Email</th>
                  <th>Coins</th>
                  <th>Posted Jobs</th>
                  <th>Total Spent</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${clients.map(c => `
                  <tr>
                    <td>
                      <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <img src="${c.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(c.displayName || 'Client') + '&background=2563eb&color=fff&size=32'}" style="width: 32px; height: 32px; border-radius: 50%;">
                        <span style="font-weight: 600;">${escapeHTML(c.displayName || 'Client')}</span>
                      </div>
                    </td>
                    <td>${escapeHTML(c.email || 'N/A')}</td>
                    <td><span style="color: #f59e0b; font-weight: 600;">${(c.coins || 0).toLocaleString()}</span></td>
                    <td>${c.postedJobs || 0}</td>
                    <td>${formatNPR(c.spent)}</td>
                    <td>
                      <button class="btn btn-primary btn-sm" onclick="viewUser('${c.id}')">View</button>
                      <button class="btn btn-warning btn-sm" onclick="openCoinModal('${c.id}', '${escapeHTML(c.displayName || c.email || 'Client')}', ${c.coins || 0})">
                        <i class="fas fa-coins"></i> Coins
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      } catch (error) {
        console.error('Error loading clients:', error);
      }
    }

    // ========== JOBS MANAGEMENT ==========
    async function loadJobs() {
      const contentArea = document.getElementById('contentArea');
      
      contentArea.innerHTML = `<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin"></i> Loading jobs...</div>`;

      try {
        const jobsSnapshot = await getDocs(collection(db, 'jobs'));
        const jobs = [];
        jobsSnapshot.forEach(doc => {
          jobs.push({ id: doc.id, ...doc.data() });
        });

        jobs.sort((a, b) => {
          const dateA = a.createdAt?.toDate?.() || new Date(0);
          const dateB = b.createdAt?.toDate?.() || new Date(0);
          return dateB - dateA;
        });

        // Get categories for filtering
        const categoriesSnapshot = await getDocs(collection(db, 'categories'));
        const categories = {};
        categoriesSnapshot.forEach(doc => {
          categories[doc.id] = doc.data().name;
        });

        contentArea.innerHTML = `
          <div class="table-container">
            <div class="table-header">
              <div class="table-title">All Jobs (${jobs.length})</div>
              <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="jobSearch" placeholder="Search jobs..." onkeyup="searchJobs()">
              </div>
            </div>
            <div class="filter-tabs" style="margin-bottom: 1rem;">
              <button class="filter-tab active" onclick="filterJobs('all')">All</button>
              <button class="filter-tab" onclick="filterJobs('open')">Open</button>
              <button class="filter-tab" onclick="filterJobs('in-progress')">In Progress</button>
              <button class="filter-tab" onclick="filterJobs('completed')">Completed</button>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Job Title</th>
                  <th>Client</th>
                  <th>Category</th>
                  <th>Budget</th>
                  <th>Status</th>
                  <th>Proposals</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="jobsTableBody">
                ${jobs.slice(0, 50).map(job => `
                  <tr class="job-row" data-status="${job.status || 'open'}">
                    <td>${escapeHTML(job.title || 'Untitled')}</td>
                    <td>${escapeHTML(job.clientName || 'Anonymous')}</td>
                    <td>${categories[job.categoryId] || job.category || 'General'}</td>
                    <td>${formatNPR(job.budget)}</td>
                    <td><span class="badge badge-${job.status === 'open' ? 'success' : job.status === 'completed' ? 'info' : 'warning'}">${job.status || 'open'}</span></td>
                    <td>${job.proposals || 0}</td>
                    <td>
                      <button class="btn btn-primary btn-sm" onclick="viewJob('${job.id}')">View</button>
                      <button class="btn btn-danger btn-sm" onclick="deleteJob('${job.id}')">Delete</button>
                    </td>
                  </tr>
                `).join('')}
                ${jobs.length === 0 ? '<tr><td colspan="7" style="text-align: center; padding: 2rem;">No jobs found</td></tr>' : ''}
              </tbody>
            </table>
          </div>
        `;
      } catch (error) {
        console.error('Error loading jobs:', error);
        contentArea.innerHTML = `<div style="color: #ef4444; padding: 2rem;">Error: ${error.message}</div>`;
      }
    }

    window.filterJobs = function(status) {
      document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.currentTarget.classList.add('active');
      
      const rows = document.querySelectorAll('.job-row');
      rows.forEach(row => {
        if (status === 'all') {
          row.style.display = 'table-row';
        } else {
          const rowStatus = row.dataset.status;
          row.style.display = rowStatus === status ? 'table-row' : 'none';
        }
      });
    };

    // ========== CATEGORIES MANAGEMENT ==========
    async function loadCategories() {
      const contentArea = document.getElementById('contentArea');
      
      contentArea.innerHTML = `<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin"></i> Loading categories...</div>`;

      try {
        const categoriesSnapshot = await getDocs(collection(db, 'categories'));
        const categories = [];
        categoriesSnapshot.forEach(doc => {
          categories.push({ id: doc.id, ...doc.data() });
        });

        // Get job counts per category
        const jobsSnapshot = await getDocs(collection(db, 'jobs'));
        const jobCounts = {};
        jobsSnapshot.forEach(doc => {
          const job = doc.data();
          if (job.categoryId) {
            jobCounts[job.categoryId] = (jobCounts[job.categoryId] || 0) + 1;
          }
        });

        contentArea.innerHTML = `
          <div class="category-section">
            <div class="table-header">
              <div class="table-title">Category Manager (${categories.length})</div>
              <button class="btn btn-primary" onclick="openCategoryModal()">
                <i class="fas fa-plus"></i> Add Category
              </button>
            </div>

            <div class="category-grid">
              ${categories.map(cat => `
                <div class="category-card">
                  <div class="category-header">
                    <span class="category-name">${escapeHTML(cat.name)}</span>
                    <div>
                      <button class="btn btn-warning btn-sm" onclick="editCategory('${cat.id}')">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="btn btn-danger btn-sm" onclick="deleteCategory('${cat.id}')">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                  <div class="category-stats">
                    <span><i class="fas fa-briefcase"></i> ${jobCounts[cat.id] || 0} jobs</span>
                    <span><i class="fas fa-percent"></i> ${cat.commission || 10}% commission</span>
                  </div>
                  <p style="font-size: 0.8rem; color: #64748b; margin-top: 0.5rem;">${escapeHTML(cat.description || 'No description')}</p>
                  <div style="margin-top: 0.5rem;">
                    <span class="badge badge-info" style="background: ${cat.color || '#2563eb'}20; color: ${cat.color || '#2563eb'};">
                      <i class="fas ${cat.icon || 'fa-tag'}"></i> ${escapeHTML(cat.name)}
                    </span>
                  </div>
                </div>
              `).join('')}
            </div>

            ${categories.length === 0 ? `
              <div style="text-align: center; padding: 3rem; color: #64748b;">
                <i class="fas fa-tags" style="font-size: 3rem;"></i>
                <p style="margin-top: 1rem;">No categories yet. Create your first category!</p>
              </div>
            ` : ''}
          </div>
        `;
      } catch (error) {
        console.error('Error loading categories:', error);
        contentArea.innerHTML = `<div style="color: #ef4444; padding: 2rem;">Error: ${error.message}</div>`;
      }
    }

    window.openCategoryModal = function() {
      currentCategoryId = null;
      document.getElementById('categoryModalTitle').textContent = 'Add Category';
      document.getElementById('categoryName').value = '';
      document.getElementById('categoryDescription').value = '';
      document.getElementById('categoryCommission').value = '10';
      document.getElementById('categoryIcon').value = 'fa-briefcase';
      document.getElementById('categoryColor').value = '#2563eb';
      document.getElementById('categoryModal').classList.add('active');
    };

    window.closeCategoryModal = function() {
      document.getElementById('categoryModal').classList.remove('active');
    };

    window.saveCategory = async function() {
      const name = document.getElementById('categoryName').value;
      const description = document.getElementById('categoryDescription').value;
      const commission = parseInt(document.getElementById('categoryCommission').value);
      const icon = document.getElementById('categoryIcon').value;
      const color = document.getElementById('categoryColor').value;

      if (!name) {
        alert('Please enter category name');
        return;
      }

      try {
        const categoryData = {
          name: name,
          description: description,
          commission: commission,
          icon: icon,
          color: color,
          updatedAt: serverTimestamp(),
          updatedBy: currentAdmin?.uid
        };

        if (currentCategoryId) {
          await updateDoc(doc(db, 'categories', currentCategoryId), categoryData);
          await logAdminActivity('category_updated', { name });
          showAlert('Category updated successfully!', 'success');
        } else {
          categoryData.createdAt = serverTimestamp();
          categoryData.createdBy = currentAdmin?.uid;
          await addDoc(collection(db, 'categories'), categoryData);
          await logAdminActivity('category_created', { name });
          showAlert('Category created successfully!', 'success');
        }

        closeCategoryModal();
        await loadCategories();

      } catch (error) {
        console.error('Error saving category:', error);
        showAlert('Error: ' + error.message, 'error');
      }
    };

    window.deleteCategory = async function(categoryId) {
      if (!confirm('Delete this category? Jobs in this category will become uncategorized.')) return;
      
      try {
        await deleteDoc(doc(db, 'categories', categoryId));
        await logAdminActivity('category_deleted', { categoryId });
        showAlert('Category deleted', 'success');
        await loadCategories();
      } catch (error) {
        showAlert('Error: ' + error.message, 'error');
      }
    };

    window.editCategory = async function(categoryId) {
      try {
        const categoryRef = doc(db, 'categories', categoryId);
        const categorySnap = await getDoc(categoryRef);
        const category = categorySnap.data();
        
        currentCategoryId = categoryId;
        document.getElementById('categoryModalTitle').textContent = 'Edit Category';
        document.getElementById('categoryName').value = category.name || '';
        document.getElementById('categoryDescription').value = category.description || '';
        document.getElementById('categoryCommission').value = category.commission || 10;
        document.getElementById('categoryIcon').value = category.icon || 'fa-briefcase';
        document.getElementById('categoryColor').value = category.color || '#2563eb';
        document.getElementById('categoryModal').classList.add('active');
      } catch (error) {
        console.error('Error loading category:', error);
        showAlert('Error loading category', 'error');
      }
    };

    // ========== SETTINGS MANAGEMENT ==========
    async function loadSettings() {
      const contentArea = document.getElementById('contentArea');

      try {
        const settingsSnapshot = await getDocs(collection(db, 'settings'));
        const settings = {};
        settingsSnapshot.forEach(doc => {
          settings[doc.id] = doc.data();
        });

        contentArea.innerHTML = `
          <div class="settings-section">
            <div class="table-header">
              <div class="table-title">Platform Settings</div>
            </div>

            <div class="settings-grid">
              <div class="settings-card">
                <div class="settings-icon">
                  <i class="fas fa-globe"></i>
                </div>
                <h3 style="margin-bottom: 1rem;">General Settings</h3>
                <div class="form-group">
                  <label>Platform Name</label>
                  <input type="text" id="platformName" value="${settings.general?.platformName || 'SewaLink'}">
                </div>
                <div class="form-group">
                  <label>Support Email</label>
                  <input type="email" id="supportEmail" value="${settings.general?.supportEmail || 'support@sewalink.com'}">
                </div>
                <div class="form-group">
                  <label>Currency</label>
                  <select id="currency">
                    <option value="NPR" ${settings.general?.currency === 'NPR' ? 'selected' : ''}>NPR (‡§∞‡•Å)</option>
                    <option value="USD" ${settings.general?.currency === 'USD' ? 'selected' : ''}>USD ($)</option>
                  </select>
                </div>
                <button class="btn btn-primary" onclick="saveGeneralSettings()">Save General Settings</button>
              </div>

              <div class="settings-card">
                <div class="settings-icon">
                  <i class="fas fa-coins"></i>
                </div>
                <h3 style="margin-bottom: 1rem;">Coin Settings</h3>
                <div class="form-group">
                  <label>Coin to Cash Rate (100 coins = ‡§∞‡•Å X)</label>
                  <input type="number" id="coinRate" value="${settings.coins?.rate || 10}">
                </div>
                <div class="form-group">
                  <label>Minimum Withdrawal (coins)</label>
                  <input type="number" id="minWithdrawal" value="${settings.coins?.minWithdrawal || 100}">
                </div>
                <div class="form-group">
                  <label>Maximum Withdrawal (coins per day)</label>
                  <input type="number" id="maxWithdrawal" value="${settings.coins?.maxWithdrawal || 5000}">
                </div>
                <button class="btn btn-primary" onclick="saveCoinSettings()">Save Coin Settings</button>
              </div>

              <div class="settings-card">
                <div class="settings-icon">
                  <i class="fas fa-shield-alt"></i>
                </div>
                <h3 style="margin-bottom: 1rem;">Security Settings</h3>
                <div class="form-group">
                  <label>Session Timeout (minutes)</label>
                  <input type="number" id="sessionTimeout" value="${settings.security?.sessionTimeout || 120}">
                </div>
                <div class="form-group">
                  <label>Max Login Attempts</label>
                  <input type="number" id="maxLoginAttempts" value="${settings.security?.maxLoginAttempts || 5}">
                </div>
                <button class="btn btn-primary" onclick="saveSecuritySettings()">Save Security Settings</button>
              </div>

              <div class="settings-card">
                <div class="settings-icon">
                  <i class="fas fa-bell"></i>
                </div>
                <h3 style="margin-bottom: 1rem;">Notification Settings</h3>
                <div class="form-group">
                  <label>
                    <input type="checkbox" id="emailNotifications" ${settings.notifications?.email ? 'checked' : ''}>
                    Email Notifications
                  </label>
                </div>
                <div class="form-group">
                  <label>
                    <input type="checkbox" id="pushNotifications" ${settings.notifications?.push ? 'checked' : ''}>
                    Push Notifications
                  </label>
                </div>
                <button class="btn btn-primary" onclick="saveNotificationSettings()">Save Notification Settings</button>
              </div>
            </div>

            <div style="margin-top: 2rem;">
              <h3 style="margin-bottom: 1rem;">System Information</h3>
              <table>
                <tr>
                  <td>Firebase Project</td>
                  <td>${firebaseConfig.projectId}</td>
                </tr>
                <tr>
                  <td>Storage Bucket</td>
                  <td>${firebaseConfig.storageBucket}</td>
                </tr>
                <tr>
                  <td>Admin UID</td>
                  <td>${currentAdmin?.uid || 'N/A'}</td>
                </tr>
                <tr>
                  <td>Last Login</td>
                  <td>${adminData?.lastActive ? new Date(adminData.lastActive.seconds * 1000).toLocaleString() : 'N/A'}</td>
                </tr>
              </table>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('Error loading settings:', error);
      }
    }

    window.saveGeneralSettings = async function() {
      const platformName = document.getElementById('platformName').value;
      const supportEmail = document.getElementById('supportEmail').value;
      const currency = document.getElementById('currency').value;

      try {
        await setDoc(doc(db, 'settings', 'general'), {
          platformName,
          supportEmail,
          currency,
          updatedAt: serverTimestamp(),
          updatedBy: currentAdmin?.uid
        }, { merge: true });

        await logAdminActivity('settings_updated', { type: 'general' });
        showAlert('General settings saved!', 'success');
      } catch (error) {
        showAlert('Error: ' + error.message, 'error');
      }
    };

    window.saveCoinSettings = async function() {
      const coinRate = parseInt(document.getElementById('coinRate').value);
      const minWithdrawal = parseInt(document.getElementById('minWithdrawal').value);
      const maxWithdrawal = parseInt(document.getElementById('maxWithdrawal').value);

      try {
        await setDoc(doc(db, 'settings', 'coins'), {
          rate: coinRate,
          minWithdrawal,
          maxWithdrawal,
          updatedAt: serverTimestamp(),
          updatedBy: currentAdmin?.uid
        }, { merge: true });

        await logAdminActivity('settings_updated', { type: 'coins' });
        showAlert('Coin settings saved!', 'success');
      } catch (error) {
        showAlert('Error: ' + error.message, 'error');
      }
    };

    window.saveSecuritySettings = async function() {
      const sessionTimeout = parseInt(document.getElementById('sessionTimeout').value);
      const maxLoginAttempts = parseInt(document.getElementById('maxLoginAttempts').value);

      try {
        await setDoc(doc(db, 'settings', 'security'), {
          sessionTimeout,
          maxLoginAttempts,
          updatedAt: serverTimestamp(),
          updatedBy: currentAdmin?.uid
        }, { merge: true });

        await logAdminActivity('settings_updated', { type: 'security' });
        showAlert('Security settings saved!', 'success');
      } catch (error) {
        showAlert('Error: ' + error.message, 'error');
      }
    };

    window.saveNotificationSettings = async function() {
      const emailNotifications = document.getElementById('emailNotifications').checked;
      const pushNotifications = document.getElementById('pushNotifications').checked;

      try {
        await setDoc(doc(db, 'settings', 'notifications'), {
          email: emailNotifications,
          push: pushNotifications,
          updatedAt: serverTimestamp(),
          updatedBy: currentAdmin?.uid
        }, { merge: true });

        await logAdminActivity('settings_updated', { type: 'notifications' });
        showAlert('Notification settings saved!', 'success');
      } catch (error) {
        showAlert('Error: ' + error.message, 'error');
      }
    };

    // ========== BLACKLIST MANAGEMENT ==========
    async function loadBlacklist() {
      const contentArea = document.getElementById('contentArea');
      
      try {
        const blacklistSnapshot = await getDocs(collection(db, 'blacklist'));
        const blacklist = [];
        blacklistSnapshot.forEach(doc => {
          blacklist.push({ id: doc.id, ...doc.data() });
        });

        contentArea.innerHTML = `
          <div class="table-container">
            <div class="table-header">
              <div class="table-title">Blacklist Manager (${blacklist.length})</div>
              <button class="btn btn-primary" onclick="openBlacklistModal()">
                <i class="fas fa-plus"></i> Add to Blacklist
              </button>
            </div>
            <table>
              <thead>
                <tr>
                  <th>User/Email</th>
                  <th>Reason</th>
                  <th>Banned By</th>
                  <th>Date</th>
                  <th>Expires</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${blacklist.map(item => {
                  const date = item.bannedAt ? new Date(item.bannedAt.seconds * 1000).toLocaleDateString() : 'Unknown';
                  const expiry = item.expiresAt ? new Date(item.expiresAt.seconds * 1000).toLocaleDateString() : 'Permanent';
                  const isExpired = item.expiresAt && new Date(item.expiresAt.seconds * 1000) < new Date();
                  
                  return `
                    <tr style="${isExpired ? 'opacity: 0.5;' : ''}">
                      <td>${escapeHTML(item.email || item.userId || 'Unknown')}</td>
                      <td>${escapeHTML(item.reason || 'No reason')}</td>
                      <td>${escapeHTML(item.bannedBy || 'System')}</td>
                      <td>${date}</td>
                      <td>${expiry}</td>
                      <td>
                        <button class="btn btn-success btn-sm" onclick="removeFromBlacklist('${item.id}')">Remove</button>
                        ${isExpired ? '<span class="badge badge-info">Expired</span>' : ''}
                      </td>
                    </tr>
                  `;
                }).join('')}
                ${blacklist.length === 0 ? '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No blacklisted users</td></tr>' : ''}
              </tbody>
            </table>
          </div>
        `;
      } catch (error) {
        console.error('Error loading blacklist:', error);
      }
    }

    window.openBlacklistModal = function() {
      document.getElementById('blacklistEmail').value = '';
      document.getElementById('blacklistReason').value = '';
      document.getElementById('blacklistDuration').value = 'permanent';
      document.getElementById('blacklistModal').classList.add('active');
    };

    window.closeBlacklistModal = function() {
      document.getElementById('blacklistModal').classList.remove('active');
    };

    window.addToBlacklist = async function() {
      const email = document.getElementById('blacklistEmail').value;
      const reason = document.getElementById('blacklistReason').value;
      const duration = document.getElementById('blacklistDuration').value;

      if (!email) {
        alert('Please enter an email');
        return;
      }

      try {
        // Find user by email
        const usersQuery = query(collection(db, 'users'), where('email', '==', email));
        const usersSnapshot = await getDocs(usersQuery);
        
        if (usersSnapshot.empty) {
          alert('User not found');
          return;
        }

        const userId = usersSnapshot.docs[0].id;
        const userData = usersSnapshot.docs[0].data();

        // Calculate expiry
        let expiresAt = null;
        if (duration !== 'permanent') {
          const days = parseInt(duration);
          expiresAt = new Date();
          expiresAt.setDate(expiresAt.getDate() + days);
        }

        // Add to blacklist
        await addDoc(collection(db, 'blacklist'), {
          userId: userId,
          email: email,
          userName: userData.displayName || email,
          reason: reason,
          bannedAt: serverTimestamp(),
          bannedBy: currentAdmin?.uid,
          expiresAt: expiresAt,
          duration: duration
        });

        // Update user status
        await updateDoc(doc(db, 'users', userId), {
          status: 'banned',
          bannedAt: serverTimestamp(),
          bannedBy: currentAdmin?.uid,
          banReason: reason,
          banExpiresAt: expiresAt
        });

        await logAdminActivity('user_banned', { userId, email, reason, duration });
        showAlert('User added to blacklist', 'success');
        closeBlacklistModal();
        await loadBlacklist();

      } catch (error) {
        console.error('Error adding to blacklist:', error);
        showAlert('Error: ' + error.message, 'error');
      }
    };

    window.removeFromBlacklist = async function(blacklistId) {
      if (!confirm('Remove from blacklist?')) return;
      
      try {
        const blacklistRef = doc(db, 'blacklist', blacklistId);
        const blacklistSnap = await getDoc(blacklistRef);
        const blacklistData = blacklistSnap.data();

        // Update user status
        if (blacklistData.userId) {
          await updateDoc(doc(db, 'users', blacklistData.userId), {
            status: 'active',
            unbannedAt: serverTimestamp(),
            unbannedBy: currentAdmin?.uid
          });
        }

        // Remove from blacklist
        await deleteDoc(blacklistRef);

        await logAdminActivity('user_unbanned', { 
          userId: blacklistData.userId, 
          email: blacklistData.email 
        });
        
        showAlert('Removed from blacklist', 'success');
        await loadBlacklist();
      } catch (error) {
        showAlert('Error: ' + error.message, 'error');
      }
    };

    // ========== ADMIN MANAGER ==========
    async function loadAdminManager() {
      const contentArea = document.getElementById('contentArea');
      
      try {
        const adminsSnapshot = await getDocs(collection(db, 'admins'));
        const admins = [];
        adminsSnapshot.forEach(doc => {
          admins.push({ id: doc.id, ...doc.data() });
        });

        contentArea.innerHTML = `
          <div class="table-container">
            <div class="table-header">
              <div class="table-title">Admin Manager (${admins.length})</div>
              <button class="btn btn-primary" onclick="window.open('https://console.firebase.google.com/project/sewalink-ead02/authentication/users', '_blank')">
                <i class="fas fa-plus"></i> Add Admin
              </button>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Admin</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Last Active</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${admins.map(admin => {
                  const lastActive = admin.lastActive ? new Date(admin.lastActive.seconds * 1000).toLocaleString() : 'Never';
                  return `
                    <tr>
                      <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                          <div style="width: 32px; height: 32px; border-radius: 50%; background: #2563eb; color: white; display: flex; align-items: center; justify-content: center;">
                            ${(admin.name || admin.email || 'A').charAt(0).toUpperCase()}
                          </div>
                          <span>${escapeHTML(admin.name || 'Admin')}</span>
                        </div>
                      </td>
                      <td>${escapeHTML(admin.email || 'N/A')}</td>
                      <td><span class="badge ${admin.role === 'super_admin' ? 'badge-danger' : 'badge-info'}">${admin.role || 'admin'}</span></td>
                      <td>${lastActive}</td>
                      <td>
                        ${admin.id !== currentAdmin?.uid ? `
                          <button class="btn btn-danger btn-sm" onclick="revokeAdmin('${admin.id}')">Revoke</button>
                        ` : 'Current'}
                      </td>
                    </tr>
                  `;
                }).join('')}
                ${admins.length === 0 ? '<tr><td colspan="5" style="text-align: center; padding: 2rem;">No admins found</td></tr>' : ''}
              </tbody>
            </table>
          </div>
        `;
      } catch (error) {
        console.error('Error loading admins:', error);
      }
    }

    window.revokeAdmin = async function(adminId) {
      if (!confirm('Revoke admin access?')) return;
      
      try {
        await deleteDoc(doc(db, 'admins', adminId));
        await logAdminActivity('admin_revoked', { adminId });
        showAlert('Admin revoked', 'success');
        loadAdminManager();
      } catch (error) {
        showAlert('Error: ' + error.message, 'error');
      }
    };

    // ========== AUDIT LOGS ==========
    async function loadAuditLogs() {
      const contentArea = document.getElementById('contentArea');
      
      try {
        const logsQuery = query(
          collection(db, 'adminLogs'),
          orderBy('timestamp', 'desc'),
          limit(100)
        );
        const logsSnapshot = await getDocs(logsQuery);
        const logs = [];
        logsSnapshot.forEach(doc => {
          logs.push({ id: doc.id, ...doc.data() });
        });

        contentArea.innerHTML = `
          <div class="table-container">
            <div class="table-header">
              <div class="table-title">Admin Audit Trail</div>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Timestamp</th>
                  <th>Admin</th>
                  <th>Action</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody>
                ${logs.map(log => {
                  const time = log.timestamp ? new Date(log.timestamp.seconds * 1000).toLocaleString() : 'Unknown';
                  return `
                    <tr>
                      <td>${time}</td>
                      <td>${escapeHTML(log.name || log.email || log.adminId?.substring(0, 8) || 'Unknown')}</td>
                      <td>${log.action || 'Unknown'}</td>
                      <td>${log.details ? JSON.stringify(log.details) : '‚Äî'}</td>
                    </tr>
                  `;
                }).join('')}
                ${logs.length === 0 ? '<tr><td colspan="4" style="text-align: center; padding: 2rem;">No audit logs yet</td></tr>' : ''}
              </tbody>
            </table>
          </div>
        `;
      } catch (error) {
        console.error('Error loading logs:', error);
      }
    }

    // ========== UTILITY FUNCTIONS ==========
    window.viewUser = function(userId) {
      window.open(`viewer.html?id=${userId}`, '_blank');
    };

    window.banUser = async function(userId) {
      if (!confirm('Ban this user?')) return;
      
      try {
        const userRef = doc(db, 'users', userId);
        const userSnap = await getDoc(userRef);
        const userData = userSnap.data();

        await updateDoc(userRef, {
          status: 'banned',
          bannedAt: serverTimestamp(),
          bannedBy: currentAdmin?.uid
        });
        
        await addDoc(collection(db, 'blacklist'), {
          userId: userId,
          email: userData.email,
          userName: userData.displayName || userData.email,
          reason: 'Banned by admin',
          bannedAt: serverTimestamp(),
          bannedBy: currentAdmin?.uid
        });
        
        await logAdminActivity('user_banned', { userId });
        showAlert('User banned', 'success');
        loadUsers();
      } catch (error) {
        showAlert('Error: ' + error.message, 'error');
      }
    };

    window.unbanUser = async function(userId) {
      if (!confirm('Unban this user?')) return;
      
      try {
        await updateDoc(doc(db, 'users', userId), {
          status: 'active',
          unbannedAt: serverTimestamp(),
          unbannedBy: currentAdmin?.uid
        });
        
        const blacklistQuery = query(collection(db, 'blacklist'), where('userId', '==', userId));
        const blacklistSnapshot = await getDocs(blacklistQuery);
        blacklistSnapshot.forEach(async (doc) => {
          await deleteDoc(doc.ref);
        });
        
        await logAdminActivity('user_unbanned', { userId });
        showAlert('User unbanned', 'success');
        loadUsers();
      } catch (error) {
        showAlert('Error: ' + error.message, 'error');
      }
    };

    window.viewJob = function(jobId) {
      window.open(`job.html?id=${jobId}`, '_blank');
    };

    window.deleteJob = async function(jobId) {
      if (!confirm('Delete this job?')) return;
      
      try {
        await deleteDoc(doc(db, 'jobs', jobId));
        await logAdminActivity('job_deleted', { jobId });
        showAlert('Job deleted', 'success');
        loadJobs();
      } catch (error) {
        showAlert('Error: ' + error.message, 'error');
      }
    };

    window.searchUsers = function() {
      const searchTerm = document.getElementById('userSearch')?.value.toLowerCase() || '';
      const rows = document.querySelectorAll('.user-row');
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? 'table-row' : 'none';
      });
    };

    window.searchJobs = function() {
      const searchTerm = document.getElementById('jobSearch')?.value.toLowerCase() || '';
      const rows = document.querySelectorAll('.job-row');
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? 'table-row' : 'none';
      });
    };

    window.viewQRScans = function(qrId) {
      showSection('scans');
    };

    // ========== AUTH STATE HANDLER ==========
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        try {
          // Check if user is admin
          const adminRef = doc(db, 'admins', user.uid);
          const adminSnap = await getDoc(adminRef);
          
          if (!adminSnap.exists()) {
            await signOut(auth);
            renderLoginPage();
            return;
          }

          currentAdmin = user;
          adminData = adminSnap.data();

          // Update last active
          await updateDoc(adminRef, {
            lastActive: serverTimestamp()
          });

          renderAdminDashboard();
        } catch (error) {
          console.error('Admin check error:', error);
          renderLoginPage();
        }
      } else {
        renderLoginPage();
      }
    });
  </script>
</body>
</html>
